package controller;

import java.io.IOException;
import java.net.URL;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.ResourceBundle;

import org.apache.log4j.Logger;

import appender.GuiAppender;

import javafx.beans.value.ChangeListener;
import javafx.beans.value.ObservableValue;
import javafx.collections.FXCollections;
import javafx.collections.ListChangeListener;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.fxml.Initializable;
import javafx.scene.control.ListView;
import javafx.scene.control.SelectionMode;
import javafx.scene.control.SplitPane;
import javafx.scene.control.TextArea;
import javafx.scene.layout.AnchorPane;
import main.App;
import model.TrackingService;
import model.TrackingServiceStub;

public class MainController implements Initializable {
	
	private static Logger logger = Logger.getLogger(App.class);
	
	@FXML
	public static TextArea console;
	@FXML
	ListView<String> list;

	@FXML
	SplitPane splitPane;

	ObservableList<String> projectsView = FXCollections.observableArrayList();
	TrackingService model = null;

	// final ObservableList<ObservableIssue> tableContent =
	// FXCollections.observableArrayList();

	/**
	 * Initializes the controller class.
	 */
	@Override
	public void initialize(URL url, ResourceBundle rsrcs) {
		logger.addAppender(new GuiAppender(console));
		
		assert list != null : "fx:id=\"list\" was not injected: check your FXML file 'IssueTrackingLite.fxml'.";
		
		logger.info(this.getClass().getSimpleName() + ".initialize");

		connectToService();
		
		
		
		
		if (list != null) {
			list.getSelectionModel().setSelectionMode(SelectionMode.SINGLE);
			list.getSelectionModel().selectedItemProperty()
					.addListener(projectItemSelected);
			displayedProjectNames.addListener(projectNamesListener);
		}

	}

	// An observable list of project names obtained from the model.
	// This is a live list, and we will react to its changes by removing
	// and adding project names to/from our list widget.
	private ObservableList<String> displayedProjectNames;

	// The list of Issue IDs relevant to the selected project. Can be null
	// if no project is selected. This list is obtained from the model.
	// This is a live list, and we will react to its changes by removing
	// and adding Issue objects to/from our table widget.

	// This listener will listen to changes in the displayedProjectNames list,
	// and update our list widget in consequence.
	private final ListChangeListener<String> projectNamesListener = new ListChangeListener<String>() {

		@Override
		public void onChanged(Change<? extends String> c) {
			if (projectsView == null) {
				return;
			}
			while (c.next()) {
				if (c.wasAdded() || c.wasReplaced()) {
					for (String p : c.getAddedSubList()) {
						projectsView.add(p);
					}
				}
				if (c.wasRemoved() || c.wasReplaced()) {
					for (String p : c.getRemoved()) {
						projectsView.remove(p);
					}
				}
			}
			FXCollections.sort(projectsView);
		}
	};

	// Connect to the model, get the project's names list, and listen to
	// its changes. Initializes the list widget with retrieved project names.
	private void connectToService() {
		if (model == null) {
			model = new TrackingServiceStub();
			displayedProjectNames = model.getProjectNames();
		}
		projectsView.clear();
		List<String> sortedProjects = new ArrayList<String>(
				displayedProjectNames);
		Collections.sort(sortedProjects);
		projectsView.addAll(sortedProjects);
		list.setItems(projectsView);
	}

	/**
	 * Return the name of the project currently selected, or null if no project
	 * is currently selected.
	 * 
	 */
	public String getSelectedProject() {
		if (model != null && list != null) {
			final ObservableList<String> selectedProjectItem = list
					.getSelectionModel().getSelectedItems();
			final String selectedProject = selectedProjectItem.get(0);
			return selectedProject;
		}
		return null;
	}

	/**
	 * Listen to changes in the list selection, and updates the table widget and
	 * DeleteIssue and NewIssue buttons accordingly.
	 */
	private final ChangeListener<String> projectItemSelected = new ChangeListener<String>() {

		@Override
		public void changed(ObservableValue<? extends String> observable,
				String oldValue, String newValue) {

			projectUnselected(oldValue);
			projectSelected(newValue);
		}
	};

	// Called when a project is unselected.
	private void projectUnselected(String oldProjectName) {
		if (oldProjectName != null) {

			System.out.println(oldProjectName + " unselected");

			// selectPan(oldProjectName, false);
		}
	}

	// Called when a project is selected.
	private void projectSelected(String newProjectName) {
		if (newProjectName != null) {
			System.out.println(newProjectName + " selected ");

			selectPan(newProjectName, true);

		}
	}

	public void selectPan(String name, boolean visible) {

//		for (int i = 0; i < splitPane.getItems().size(); i++)
//			splitPane.getItems().remove(i);

		try {
			AnchorPane page = null;

			switch (name) {
			case "Message Digest":
				page = (AnchorPane) FXMLLoader.load(App.class.getResource("messageDigest.fxml"));
				System.out.println(name);
				System.out.println("Message");
				break;
			case "Key Generator":
				page = (AnchorPane) FXMLLoader.load(App.class.getResource("keyGenerator.fxml"));
				System.out.println(name);
				System.out.println("Key");
				break;
			}

//			if (page != null)
//				splitPane.getItems().add(page);
			if (splitPane.getItems().get(0) != null && page != null) {
				splitPane.getItems().remove(0);
				splitPane.getItems().add(0, page);
			}
			
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}

}
